## 1) Настройте сервер так, чтобы в журнал сообщений сбрасывалась информация о блокировках, удерживаемых более 200 миллисекунд.

### postgresql.conf
log_lock_waits = on
deadlock_timeout = 200ms

### input
* SELECT pg_reload_conf();
* SHOW log_lock_waits;
* SHOW deadlock_timeout;
---


## 2) Воспроизведите ситуацию, при которой в журнале появятся такие сообщения. Смоделируйте ситуацию обновления одной и той же строки тремя командами UPDATE в разных сеансах. Изучите возникшие блокировки в представлении pg_locks и убедитесь, что все они понятны.

### Prepare test
```
CREATE TABLE test ( 
    id serial,
    fio char(100)
);
INSERT INTO test(fio) select 'fio ' || (random()::text) FROM generate_series(1, 1000000);;
```

### Console 1
```
BEGIN;
update test set fio = 'session1' where id = 42
```

### Console 2
```
BEGIN;
update test set fio = 'session2' where id = 42
```

### Console 3
```
BEGIN;
update test set fio = 'session3' where id = 42
```

### Log
```
2025-07-13 18:39:33 MSK СООБЩЕНИЕ:  процесс 16456 продолжает ожидать в режиме ShareLock блокировку "транзакция 344992" в течение 210.852 мс
2025-07-13 18:39:33 MSK ПОДРОБНОСТИ:  Process holding the lock: 8820. Wait queue: 16456.
2025-07-13 18:39:33 MSK КОНТЕКСТ:  при изменении кортежа (17241,25) в отношении "test"
2025-07-13 18:39:33 MSK ОПЕРАТОР:  begin;
	update test set fio = 'session2' where id = 42
2025-07-13 18:39:36 MSK СООБЩЕНИЕ:  процесс 15964 продолжает ожидать в режиме ExclusiveLock блокировку "кортеж (17241,25) отношения 16575 базы данных 5" в течение 208.483 мс
2025-07-13 18:39:36 MSK ПОДРОБНОСТИ:  Process holding the lock: 16456. Wait queue: 15964.
2025-07-13 18:39:36 MSK ОПЕРАТОР:  begin;
	update test set fio = 'session3' where id = 422025-07-13 18:23:12 MSK СООБЩЕНИЕ:  система БД была выключена: 2025-07-12 11:53:05 MSK

```
### SELECT pid, relation::REGCLASS, locktype, virtualxid, transactionid, mode, granted FROM pg_locks
---

## 3) Воспроизведите взаимоблокировку трех транзакций. Можно ли разобраться в ситуации постфактум, изучая журнал сообщений?

### Console1
```
begin;
update test set fio = 'deadlock1' where id = 1;
```
### Console2
```
begin;
update test set fio = 'deadlock2' where id = 2;
```
### Console3
```
begin;
update test set fio = 'deadlock3' where id = 1;
```
### Console1
```
update test set fio = 'deadlock1_2' where id = 2;

```
### Console2
```
update test set fio = 'deadlock2_2' where id = 1;
```
### Error 
```
ОШИБКА:  обнаружена взаимоблокировка
SQL state: 40P01
Detail: Процесс 10144 ожидает в режиме ExclusiveLock блокировку "кортеж (17241,17) отношения 16575 базы данных 5"; заблокирован процессом 10740.
Процесс 10740 ожидает в режиме ShareLock блокировку "транзакция 344998"; заблокирован процессом 11976.
Процесс 11976 ожидает в режиме ShareLock блокировку "транзакция 344999"; заблокирован процессом 10144.
Hint: Подробности запроса смотрите в протоколе сервера.
```
### Log
```
2025-07-13 19:20:48 MSK СООБЩЕНИЕ:  процесс 10740 продолжает ожидать в режиме ShareLock блокировку "транзакция 344998" в течение 200.230 мс
2025-07-13 19:20:48 MSK ПОДРОБНОСТИ:  Process holding the lock: 11976. Wait queue: 10740.
2025-07-13 19:20:48 MSK КОНТЕКСТ:  при изменении кортежа (17241,17) в отношении "test"
2025-07-13 19:20:48 MSK ОПЕРАТОР:  begin;
	update test set fio = 'deadlock3' where id = 1;
2025-07-13 19:20:51 MSK СООБЩЕНИЕ:  процесс 11976 продолжает ожидать в режиме ShareLock блокировку "транзакция 344999" в течение 214.741 мс
2025-07-13 19:20:51 MSK ПОДРОБНОСТИ:  Process holding the lock: 10144. Wait queue: 11976.
2025-07-13 19:20:51 MSK КОНТЕКСТ:  при изменении кортежа (17241,18) в отношении "test"
2025-07-13 19:20:51 MSK ОПЕРАТОР:  update test set fio = 'deadlock1_2' where id = 2;
2025-07-13 19:20:56 MSK СООБЩЕНИЕ:  процесс 10144 обнаружил взаимоблокировку, ожидая в режиме ExclusiveLock блокировку "кортеж (17241,17) отношения 16575 базы данных 5" в течение 212.135 мс
2025-07-13 19:20:56 MSK ПОДРОБНОСТИ:  Process holding the lock: 10740. Wait queue: .
2025-07-13 19:20:56 MSK ОПЕРАТОР:  update test set fio = 'deadlock2_2' where id = 1;
	
2025-07-13 19:20:56 MSK ОШИБКА:  обнаружена взаимоблокировка
2025-07-13 19:20:56 MSK ПОДРОБНОСТИ:  Процесс 10144 ожидает в режиме ExclusiveLock блокировку "кортеж (17241,17) отношения 16575 базы данных 5"; заблокирован процессом 10740.
	Процесс 10740 ожидает в режиме ShareLock блокировку "транзакция 344998"; заблокирован процессом 11976.
	Процесс 11976 ожидает в режиме ShareLock блокировку "транзакция 344999"; заблокирован процессом 10144.
	Процесс 10144: update test set fio = 'deadlock2_2' where id = 1;
	
	Процесс 10740: begin;
	update test set fio = 'deadlock3' where id = 1;
	Процесс 11976: update test set fio = 'deadlock1_2' where id = 2;
2025-07-13 19:20:56 MSK ПОДСКАЗКА:  Подробности запроса смотрите в протоколе сервера.
2025-07-13 19:20:56 MSK ОПЕРАТОР:  update test set fio = 'deadlock2_2' where id = 1;
	
2025-07-13 19:20:56 MSK СООБЩЕНИЕ:  процесс 11976 получил в режиме ShareLock блокировку "транзакция 344999" через 5009.932 мс
2025-07-13 19:20:56 MSK КОНТЕКСТ:  при изменении кортежа (17241,18) в отношении "test"
2025-07-13 19:20:56 MSK ОПЕРАТОР:  update test set fio = 'deadlock1_2' where id = 2;

```

### Result
* В log-файле ведется:
	* запрос, инициировавший блокировку;
	* атрибуты блокировки;
	* PID процессов, ожидающих и удерживающих блокировку.
* Таким образом можно определить участников и причины случившейся блокировки.
---
